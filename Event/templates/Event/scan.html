{% block content %}
<div class="card card-custom">
    <h2>Scan QR Code</h2>
    <div id="preview"></div>
    <p id="result"></p>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- Load library at the very end -->
<script src="https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const qrCodeRegionId = "preview";
    const html5QrCode = new Html5Qrcode(qrCodeRegionId);

    function startScanner() {
        Html5Qrcode.getCameras().then(cameras => {
            if (cameras && cameras.length) {
                let cameraId = cameras.find(cam => cam.label.toLowerCase().includes("back"))?.id || cameras[0].id;

                html5QrCode.start(
                    { deviceId: { exact: cameraId } },
                    { fps: 10, qrbox: 250 },
                    qrCodeMessage => {
                        console.log("Scanned QR:", qrCodeMessage);

                        html5QrCode.stop().then(() => {
                            fetch(`/mark_attendance/${qrCodeMessage}/`)
                                .then(res => res.json())
                                .then(data => {
                                    document.getElementById("result").innerText = data.message;
                                }).catch(() => {
                                    document.getElementById("result").innerText = "Error marking attendance";
                                });

                            setTimeout(() => {
                                document.getElementById("result").innerText = "";
                                startScanner();
                            }, 3000);
                        });
                    },
                    err => console.warn(err)
                ).catch(err => console.error("Camera start failed:", err));

            } else {
                document.getElementById("result").innerText = "No camera found";
            }
        }).catch(err => {
            console.error("Camera access error:", err);
            document.getElementById("result").innerText = "Cannot access camera";
        });
    }

    startScanner();
});
</script>
{% endblock %}
